name: Build On Tag & Publish Draft
on:
    push:
        tags:
            - 'v[0-9]+.[0-9]+.[0-9]+'
jobs:
    release-draft:
        if: startsWith(github.ref, 'refs/tags/v')
        name: Prepare Release Draft
        runs-on: ubuntu-latest
        needs:
            - build
        permissions:
            contents: write
            pull-requests: write
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Download MNCPlay for Windows x64
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-windows-amd64
            - name: Download MNCPlay for Windows x32
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-windows-386
            - name: Download MNCPlay for Windows ARM
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-windows-arm64
            - name: Download MNCPlay for Mac Intel
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-darwin-amd64
            - name: Download MNCPlay for Mac M1
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-darwin-arm64
            - name: Download MNCPlay for Mac Universal
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-darwin-universal
            - name: Download MNCPlay for Linux x64
              uses: actions/download-artifact@v4
              with:
                  name: mncplay-linux-amd64
            - name: Get Previous Tag
              id: previoustag
              uses: WyriHaximus/github-action-get-previous-tag@v1
              with:
                  fallback: v0.0.0
            - name: Release
              uses: ncipollo/release-action@v1
              with:
                draft: true
                name: 'üöÄ MNCPlay ${{ github.ref_name }}'
                body: |
                    <div align="center">
                    <table>
                        <tr>
                          <td align="center" colspan="3">
                            <b>MNCPlay ${{ github.ref_name }}</b>
                          </td>
                        </tr>
                        <tr>
                          <td align="center">Windows</td>
                          <td align="center">MacOS</td>
                          <td align="center">Linux</td>
                        </tr>
                        <tr>
                          <td>
                            <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-windows-amd64.exe" target="_blank">
                              <img width="100" src="https://raw.githubusercontent.com/mncred/play/main/.github/assets/logo-windows.png"></img>
                            </a>
                          </td>
                          <td>
                            <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-darwin-universal.zip" target="_blank">
                              <img width="100" src="https://raw.githubusercontent.com/mncred/play/main/.github/assets/logo-apple.png"></img>
                            </a>
                          </td>
                          <td>
                            <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-linux-amd64" target="_blank">
                              <img width="100" src="https://raw.githubusercontent.com/mncred/play/main/.github/assets/logo-linux.png"></img>
                            </a>
                          </td>
                        </tr>
                        <tr>
                          <td align="center" colspan="3">
                            <b>–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã</b>
                          </td>
                        </tr>
                        <tr>
                          <td colspan="3">
                            Windows ‡±º <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-windows-amd64.exe" target="_blank">x64</a> ‚Ä¢ <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-windows-386.exe" target="_blank">x32</a> ‚Ä¢ <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-windows-arm64.exe" target="_blank">ARM</a>
                          </td>
                        </tr>
                        <tr>
                          <td colspan="3">
                            MacOS ‡±º <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-darwin-amd64.zip" target="_blank">Intel</a> ‚Ä¢ <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-darwin-arm64.zip" target="_blank">M1</a> ‚Ä¢ <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-darwin-universal.exe" target="_blank">Universal</a>
                          </td>
                        </tr>
                        <tr>
                          <td colspan="3">
                            Linux ‡±º <a href="https://github.com/mncred/play/releases/download/${{ github.ref_name }}/mncplay-linux-amd64" target="_blank">x64</a>
                          </td>
                        </tr>
                      </table>
                    </div>

                    ## ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–ª–∏–∑–µ

                      ### üåà –ß—Ç–æ –Ω–æ–≤–æ–≥–æ

                      //TODO: –û–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏–π

                      ### üêû –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫

                      //TODO: –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫

                      ### üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ 

                      - üìí –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π - [${{ steps.previoustag.outputs.tag }} -> ${{ github.ref_name }}](https://github.com/mncred/play/compare/${{ steps.previoustag.outputs.tag }}...${{ github.ref_name }})
                      - üêû –ù–∞—à–ª–∏ –±–∞–≥? - [–î–æ–ª–æ–∂–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ](https://github.com/mncred/play/issues/new?assignees=jkulvich&labels=bug&projects=&template=bug-report.md&title=%F0%9F%90%9E+%5BBUG%5D%3A+%D0%94%D0%BE%D0%BA%D0%BB%D0%B0%D0%B4+%D0%BE%D0%B1+%D0%BE%D1%88%D0%B8%D0%B1%D0%BA%D0%B5)
                      - üí° –ï—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ? - [–ó–∞–ø—Ä–æ—Å –Ω–∞ —É–ª—É—á—à–µ–Ω–∏–µ](https://github.com/mncred/play/issues/new?assignees=jkulvich&labels=enhancement&projects=&template=feature-request.md&title=%F0%9F%8C%88+%5BFEATURE%5D%3A+%D0%97%D0%B0%D0%BF%D1%80%D0%BE%D1%81+%D0%BD%D0%B0+%D1%83%D0%BB%D1%83%D1%87%D1%88%D0%B5%D0%BD%D0%B8%D0%B5)
                      - üÜò –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å? - [–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É](https://github.com/mncred/play/issues/new?assignees=jkulvich&labels=help+wanted&projects=&template=help-wanted.md&title=%F0%9F%86%98+%5BHELP%5D%3A+%D0%97%D0%B0%D0%BF%D1%80%D0%BE%D1%81+%D0%BD%D0%B0+%D0%BF%D0%BE%D0%B4%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D1%83)

                    ## ‚≠êÔ∏è –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç

                    –ü—Ä–æ–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–∞ –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ–π –æ—Å–Ω–æ–≤–µ –∏ –æ—Ç–∫—Ä—ã—Ç –¥–ª—è —Å–≤–æ–±–æ–¥–Ω–æ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è.
                    –í—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ø–æ—Å—Ç–∞–≤–∏–≤ –∑–≤–µ–∑–¥—É –Ω–∞ GitHub, —Å–¥–µ–ª–∞–≤ —Ñ–æ—Ä–∫ –∏ –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç, –∏–ª–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ.
                    –°—Ä–µ–¥—Å—Ç–≤–∞ –ø–æ–π–¥—É—Ç –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, –∞ —Ç–∞–∫ –∂–µ —Å–≤—è–∑–∞–Ω–Ω–æ–π —ç–∫–æ—Å–∏—Å—Ç–µ–º—ã
                    –∏ –æ–ø–ª–∞—Ç—É —Å–µ—Ä–≤–µ—Ä–æ–≤. –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —É—Å–∫–æ—Ä–∏—Ç –≤—ã—Ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π.

                    <div align="center">
                      <table>
                        <tr>
                          <td align="center">
                            CloudTips
                          </td>
                          <td align="center">
                            Boosty
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <a href="https://pay.cloudtips.ru/p/46677d4f" target="_blank">
                              <img width="150" src="https://raw.githubusercontent.com/mncred/play/main/.github/assets/qr-cloudtips-donate.png"></img>
                            </a>
                          </td>
                          <td>
                            <a href="https://boosty.to/jkulvich/donate" target="_blank">
                              <img width="150" src="https://raw.githubusercontent.com/mncred/play/main/.github/assets/qr-boosty-donate.png"></img>
                            </a>
                          </td>
                        </tr>
                      </table>
                    </div>

                    ## ‚ù§Ô∏è –ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏

                    –í—ã—Ä–∞–∂–∞–µ–º –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥–µ [Wails](https://wails.io) –∑–∞ –æ—Ç–ª–∏—á–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏,
                    –∞ —Ç–∞–∫ –∂–µ –≤—Å–µ–º, –∫—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç.

                    <div align="center">
                      <table>
                        <tr>
                          <td align="center">
                            –ü–æ–¥–¥–µ—Ä–∂–∞–ª–∏ –ø–æ—Å—Ç–∞–≤–∏–≤ –∑–≤–µ–∑–¥—É
                          </td>
                          <td align="center">
                            –ü–æ–¥–¥–µ—Ä–∂–∞–ª–∏ —Å–¥–µ–ª–∞–≤ —Ñ–æ—Ä–∫
                          </td>
                        </tr>
                        </tr>
                          <td>
                            <a href="https://github.com/mncred/play/stargazers" target="_blank">
                              <img src="https://reporoster.com/stars/notext/mncred/play"></img>
                            </a>
                          </td>
                          <td>
                            <a href="https://github.com/mncred/play/network/members" target="_blank">
                              <img src="https://reporoster.com/forks/notext/mncred/play"></img>
                            </a>
                          </td>
                        </tr>
                      </table>
                    </div>
                skipIfReleaseExists: true
                allowUpdates: true
                generateReleaseNotes: false
                artifactErrorsFailBuild: true
                replacesArtifacts: true
                artifacts: 'mncplay-*'

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: 
            - build-linux
            - build-darwin
            - build-windows
        steps:
            - name: Checkout
              uses: actions/checkout@v4

    build-windows:
        name: Build For Windows
        runs-on: windows-latest
        needs: 
            - build-windows-amd64
            - build-windows-386
            - build-windows-arm64
        steps:
            - name: Checkout
              uses: actions/checkout@v4

    build-windows-amd64:
        name: windows/amd64
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_windows_amd64
            - name: Install UPX
              uses: crazy-max/ghaction-upx@v3
              with:
                install-only: true
            - name: UPX
              run: upx -9 build/bin/mncplay-windows-amd64.exe
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                name: mncplay-windows-amd64
                path: build/bin/mncplay-windows-amd64.exe

    build-windows-386:
        name: windows/386
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_windows_386
            - name: Install UPX
              uses: crazy-max/ghaction-upx@v3
              with:
                install-only: true
            - name: UPX
              run: upx -9 build/bin/mncplay-windows-386.exe
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                name: mncplay-windows-386
                path: build/bin/mncplay-windows-386.exe

    build-windows-arm64:
        name: windows/arm64
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_windows_arm64
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                name: mncplay-windows-arm64
                path: build/bin/mncplay-windows-arm64.exe

    build-darwin:
        name: Build For MacOS
        runs-on: macos-latest
        needs: 
            - build-darwin-amd64
            - build-darwin-arm64
            - build-darwin-universal
        steps:
            - name: Checkout
              uses: actions/checkout@v4

    build-darwin-amd64:
        name: darwin/amd64
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                  go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_darwin_amd64
            - name: ZIP The App
              run: cd build/bin && zip -9 -r mncplay-darwin-amd64.zip mncplay-darwin-amd64.app
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: mncplay-darwin-amd64
                  path: build/bin/mncplay-darwin-amd64.zip

    build-darwin-arm64:
        name: darwin/arm64
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                  go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_darwin_arm64
            - name: ZIP The App
              run: cd build/bin && zip -9 -r mncplay-darwin-arm64.zip mncplay-darwin-arm64.app
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: mncplay-darwin-arm64
                  path: build/bin/mncplay-darwin-arm64.zip

    build-darwin-universal:
        name: darwin/universal
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                  go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_darwin_universal
            - name: ZIP The App
              run: cd build/bin && zip -9 -r mncplay-darwin-universal.zip mncplay-darwin-universal.app
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: mncplay-darwin-universal
                  path: build/bin/mncplay-darwin-universal.zip

    build-linux:
        name: Build For Linux
        runs-on: ubuntu-latest
        needs: 
            - build-linux-amd64
            # - build-linux-arm
            # - build-linux-arm64
        steps:
            - name: Checkout
              uses: actions/checkout@v4

    build-linux-amd64:
        name: linux/amd64
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: APT Update
              run: sudo apt-get update
            - name: Install WebKit2 GTK 4.0
              run: sudo apt-get install libwebkit2gtk-4.0-dev 
            - name: Install GTK+ 3.0
              run: sudo apt-get install libgtk-3-dev
            - name: Install Go
              uses: actions/setup-go@v5
              with:
                  go-version: '>=1.21'
            - name: Install Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20
            - name: Install Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
            - name: Build App
              run: make build_linux_amd64
            - name: UPX
              run: upx -9 build/bin/mncplay-linux-amd64
            - name: Save Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: mncplay-linux-amd64
                  path: build/bin/mncplay-linux-amd64

    # build-linux-arm64:
    #     name: linux/arm64
    #     runs-on: ubuntu-latest
    #     steps:
    #         - name: Checkout
    #           uses: actions/checkout@v4
    #         - name: APT Update
    #           run: sudo apt-get update
    #         - name: Install WebKit2 GTK 4.0
    #           run: sudo apt-get install libwebkit2gtk-4.0-dev 
    #         - name: Install GTK+ 3.0
    #           run: sudo apt-get install libgtk-3-dev
    #         - name: Install Go
    #           uses: actions/setup-go@v5
    #           with:
    #               go-version: '>=1.21'
    #         - name: Install Node
    #           uses: actions/setup-node@v4
    #           with:
    #               node-version: 20
    #         - name: Install Wails
    #           run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
    #         - name: Build App
    #           run: make build_linux_arm64
    #         - name: Save Artifact
    #           uses: actions/upload-artifact@v4
    #           with:
    #               name: mncplay-linux-arm64
    #               path: build/bin/mncplay-linux-arm64

    # build-linux-arm:
    #     name: linux/arm
    #     runs-on: ubuntu-latest
    #     steps:
    #         - name: Checkout
    #           uses: actions/checkout@v4
    #         - name: APT Update
    #           run: sudo apt-get update
    #         - name: Install WebKit2 GTK 4.0
    #           run: sudo apt-get install libwebkit2gtk-4.0-dev 
    #         - name: Install GTK+ 3.0
    #           run: sudo apt-get install libgtk-3-dev
    #         - name: Install Go
    #           uses: actions/setup-go@v5
    #           with:
    #               go-version: '>=1.21'
    #         - name: Install Node
    #           uses: actions/setup-node@v4
    #           with:
    #               node-version: 20
    #         - name: Install Wails
    #           run: go install github.com/wailsapp/wails/v2/cmd/wails@latest
    #         - name: Build App
    #           run: make build_linux_arm
    #         - name: Save Artifact
    #           uses: actions/upload-artifact@v4
    #           with:
    #               name: mncplay-linux-arm
    #               path: build/bin/mncplay-linux-arm
